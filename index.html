<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeknoHıfz Dijital Merkez v3</title>
    
    <!-- Tailwind CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        :root {
            --color-navy: #15324A;
            --color-turquoise: #4FC3F7;
            --color-gold: #FFC300;
            --color-surface: #FFFFFF;
            --color-resolved: #4CAF50;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F5F7FA;
            color: var(--color-navy);
        }
        
        .btn-primary {
            background-color: var(--color-turquoise);
            color: var(--color-navy);
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .card {
            background-color: var(--color-surface);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            border-top: 3px solid var(--color-gold);
        }
        
        .thread-card {
            background-color: var(--color-surface);
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            border-left: 3px solid var(--color-turquoise);
        }
        
        .thread-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .thread-card.solved {
            border-left: 3px solid var(--color-resolved);
        }
        
        .nav-item {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-item:hover, .nav-item.active {
            background-color: rgba(79, 195, 247, 0.1);
            color: var(--color-turquoise);
        }
        
        .category-pill {
            background-color: rgba(79, 195, 247, 0.1);
            color: var(--color-turquoise);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .pinned-news {
            border-left: 3px solid var(--color-gold);
            background-color: rgba(255, 195, 0, 0.05);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="ph ph-code text-2xl text-turquoise"></i>
                <h1 class="text-xl font-bold">TeknoHıfz Dijital Merkez</h1>
            </div>
            <div id="user-info" class="flex items-center gap-2">
                <span id="user-name" class="text-sm font-medium">Yükleniyor...</span>
                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                    <i class="ph ph-user text-gray-500"></i>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="flex-1 container mx-auto px-4 py-6">
        <!-- Navigation -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <aside class="md:col-span-1">
                <div class="card p-4">
                    <h2 class="font-bold text-lg mb-4">Menü</h2>
                    <nav class="flex flex-col gap-1">
                        <a href="#" class="nav-item active" onclick="setView('home')">
                            <i class="ph ph-house"></i>
                            <span>Ana Sayfa</span>
                        </a>
                        <a href="#" class="nav-item" onclick="setView('forum')">
                            <i class="ph ph-chats-circle"></i>
                            <span>Forum</span>
                        </a>
                        <a href="#" class="nav-item" onclick="setView('news')">
                            <i class="ph ph-newspaper"></i>
                            <span>Haberler</span>
                        </a>
                    </nav>
                </div>
            </aside>
            
            <!-- Content Area -->
            <div class="md:col-span-3">
                <div id="view-container">
                    <!-- Views will be dynamically loaded here -->
                    <div id="loading-view" class="flex items-center justify-center h-64">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-turquoise"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="bg-white border-t py-4">
        <div class="container mx-auto px-4 text-center text-sm text-gray-500">
            <p>© 2023 Akşemseddin İHO TeknoHıfz Kulübü. Tüm hakları saklıdır.</p>
        </div>
    </footer>
    
    <!-- View Templates -->
    <template id="home-view">
        <div class="space-y-6">
            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4">TeknoHıfz Dijital Merkez'e Hoş Geldiniz</h2>
                <p class="mb-4">Bu platform, Akşemseddin İHO TeknoHıfz Kulübü öğrencileri için dijital bir buluşma noktasıdır. Burada:</p>
                <ul class="list-disc pl-5 space-y-2 mb-4">
                    <li>Kodlama, teknoloji ve hafızlık konularında sorular sorabilir,</li>
                    <li>Diğer öğrencilerin sorularını yanıtlayabilir,</li>
                    <li>Okul duyurularını takip edebilirsiniz.</li>
                </ul>
                <div class="flex gap-4">
                    <button class="btn-primary" onclick="setView('forum')">
                        <i class="ph ph-chats-circle mr-1"></i> Forum'a Git
                    </button>
                    <button class="btn-primary" onclick="setView('news')">
                        <i class="ph ph-newspaper mr-1"></i> Haberleri Gör
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="card p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="ph ph-trend-up text-xl text-turquoise"></i>
                        <h3 class="font-bold">Popüler Konular</h3>
                    </div>
                    <div id="popular-threads" class="space-y-3">
                        <p class="text-gray-500 text-sm">Yükleniyor...</p>
                    </div>
                </div>
                
                <div class="card p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="ph ph-bell-ringing text-xl text-gold"></i>
                        <h3 class="font-bold">Son Duyurular</h3>
                    </div>
                    <div id="recent-news" class="space-y-3">
                        <p class="text-gray-500 text-sm">Yükleniyor...</p>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <template id="forum-view">
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Forum</h2>
                <button id="new-thread-btn" class="btn-primary">
                    <i class="ph ph-plus mr-1"></i> Yeni Konu
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div id="forum-categories" class="md:col-span-3 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Categories will be loaded here -->
                    <p class="text-gray-500 text-sm">Kategoriler yükleniyor...</p>
                </div>
            </div>
            
            <div id="category-filter" class="flex items-center gap-2 mb-4">
                <span class="text-sm font-medium">Kategori:</span>
                <select id="category-select" class="border rounded-md px-2 py-1 text-sm">
                    <option value="all">Tümü</option>
                    <!-- Categories will be loaded here -->
                </select>
            </div>
            
            <div id="forum-threads" class="space-y-4">
                <!-- Threads will be loaded here -->
                <p class="text-gray-500">Konular yükleniyor...</p>
            </div>
            
            <!-- New Thread Form (Hidden by default) -->
            <div id="new-thread-form" class="card p-6 hidden">
                <h3 class="text-xl font-bold mb-4">Yeni Konu Oluştur</h3>
                <form id="thread-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Başlık</label>
                        <input type="text" id="thread-title" class="w-full border rounded-lg p-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Kategori</label>
                        <select id="thread-category" class="w-full border rounded-lg p-2" required>
                            <!-- Categories will be loaded here -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">İçerik</label>
                        <textarea id="thread-content" class="w-full border rounded-lg p-2 min-h-[120px]" required></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="btn-primary">Gönder</button>
                        <button type="button" class="btn-primary bg-gray-200 text-gray-700" onclick="toggleNewThreadForm()">İptal</button>
                    </div>
                </form>
            </div>
            
            <!-- Admin Category Management (Hidden by default) -->
            <div id="admin-category-form" class="card p-6 hidden">
                <h3 class="text-xl font-bold mb-4">Yeni Kategori Ekle (Yönetici)</h3>
                <form id="category-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Kategori ID (küçük harf ve tire)</label>
                        <input type="text" id="category-id" class="w-full border rounded-lg p-2" required pattern="[a-z0-9-]+">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Kategori Adı</label>
                        <input type="text" id="category-name" class="w-full border rounded-lg p-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Açıklama</label>
                        <textarea id="category-description" class="w-full border rounded-lg p-2" required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">İkon (Phosphor Icons ismi)</label>
                        <input type="text" id="category-icon" class="w-full border rounded-lg p-2" value="folder" required>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="btn-primary">Kategori Ekle</button>
                        <button type="button" class="btn-primary bg-gray-200 text-gray-700" onclick="toggleAdminCategoryForm()">İptal</button>
                    </div>
                </form>
            </div>
        </div>
    </template>
    
    <template id="thread-detail-view">
        <div class="space-y-6">
            <div class="flex items-center gap-2 text-sm mb-4">
                <a href="#" onclick="setView('forum')" class="text-turquoise hover:underline flex items-center gap-1">
                    <i class="ph ph-arrow-left"></i>
                    <span>Forum'a Dön</span>
                </a>
            </div>
            
            <div id="thread-detail" class="card p-6">
                <!-- Thread details will be loaded here -->
                <p class="text-gray-500">Konu yükleniyor...</p>
            </div>
            
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Cevaplar</h3>
                <span id="reply-count" class="text-sm text-gray-500">0 cevap</span>
            </div>
            
            <div id="thread-replies" class="space-y-4">
                <!-- Replies will be loaded here -->
                <p class="text-gray-500">Cevaplar yükleniyor...</p>
            </div>
            
            <div class="card p-6">
                <h3 class="text-lg font-bold mb-4">Cevap Yaz</h3>
                <form id="reply-form" class="space-y-4">
                    <div>
                        <textarea id="reply-content" class="w-full border rounded-lg p-2 min-h-[120px]" required placeholder="Düşüncelerinizi buraya yazın..."></textarea>
                    </div>
                    <button type="submit" class="btn-primary">Cevabı Gönder</button>
                </form>
            </div>
        </div>
    </template>
    
    <template id="news-view">
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Haberler ve Duyurular</h2>
                <div id="admin-news-controls" class="hidden">
                    <button id="new-news-btn" class="btn-primary">
                        <i class="ph ph-plus mr-1"></i> Yeni Duyuru
                    </button>
                </div>
            </div>
            
            <div id="pinned-news" class="space-y-4">
                <!-- Pinned news will be loaded here -->
            </div>
            
            <div id="news-list" class="space-y-4">
                <!-- News will be loaded here -->
                <p class="text-gray-500">Haberler yükleniyor...</p>
            </div>
            
            <!-- New News Form (Hidden by default) -->
            <div id="new-news-form" class="card p-6 hidden">
                <h3 class="text-xl font-bold mb-4">Yeni Duyuru Ekle</h3>
                <form id="news-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Başlık</label>
                        <input type="text" id="news-title" class="w-full border rounded-lg p-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">İçerik</label>
                        <textarea id="news-content" class="w-full border rounded-lg p-2 min-h-[120px]" required></textarea>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="news-pinned" class="rounded">
                        <label for="news-pinned" class="text-sm font-medium">Önemli Duyuru (Sabitlenmiş)</label>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="btn-primary">Duyuru Ekle</button>
                        <button type="button" class="btn-primary bg-gray-200 text-gray-700" onclick="toggleNewNewsForm()">İptal</button>
                    </div>
                </form>
            </div>
        </div>
    </template>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            query, 
            where, 
            orderBy, 
            limit, 
            serverTimestamp, 
            increment 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getAuth, 
            signInWithCustomToken, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBVZcUkLK7yJUDHnfpgVnHnkUzYsYYmYYY",
            authDomain: "teknohifz-digital-hub.firebaseapp.com",
            projectId: "teknohifz-digital-hub",
            storageBucket: "teknohifz-digital-hub.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Global state
        window.state = {
            currentView: 'home',
            forumThreads: [],
            forumCategories: [],
            currentThread: null,
            currentThreadReplies: [],
            schoolNews: [],
            userId: null,
            userName: 'Misafir',
            userRole: 'GUEST'
        };
        
        // Constants
        const ADMIN_UID_SIM = "admin-ak-tekno-hifz-12345";
        const APP_ID = "teknohifz-digital-hub-v3";
        const DEFAULT_FORUM_CATEGORIES = [
            {
                id: "genel",
                name: "Genel",
                description: "Genel konular ve sorular",
                icon: "chat-circle"
            },
            {
                id: "yazilim",
                name: "Yazılım",
                description: "Programlama ve kodlama soruları",
                icon: "code"
            },
            {
                id: "hafizlik",
                name: "Hafızlık",
                description: "Hafızlık teknikleri ve yardımlaşma",
                icon: "book-open"
            },
            {
                id: "donanim",
                name: "Donanım",
                description: "Bilgisayar donanımı ve elektronik",
                icon: "device-mobile"
            }
        ];
        
        // Firestore path helpers
        const getCollectionPath = (collectionName) => {
            return `/artifacts/${APP_ID}/public/data/${collectionName}`;
        };
        
        // Authentication
        async function initAuth() {
            try {
                // Try to get initial auth token from Canvas (if available)
                const initialToken = window.__initial_auth_token || null;
                
                if (initialToken) {
                    await signInWithCustomToken(auth, initialToken);
                } else {
                    // Fall back to anonymous auth
                    await signInAnonymously(auth);
                }
                
                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        state.userId = user.uid;
                        
                        // Check if user is admin (simulated)
                        if (user.uid === ADMIN_UID_SIM) {
                            state.userRole = 'ADMIN';
                            state.userName = 'YÖNETİCİ';
                        } else {
                            state.userRole = 'GUEST';
                            state.userName = `Misafir-${user.uid.substring(0, 8)}`;
                        }
                        
                        // Update UI
                        document.getElementById('user-name').textContent = state.userName;
                        
                        // Show admin controls if admin
                        if (state.userRole === 'ADMIN') {
                            const adminNewsControls = document.getElementById('admin-news-controls');
                            if (adminNewsControls) adminNewsControls.classList.remove('hidden');
                            
                            // Add admin category button to forum view
                            if (state.currentView === 'forum') {
                                const forumHeader = document.querySelector('#forum-view .flex.justify-between');
                                if (forumHeader && !document.getElementById('admin-category-btn')) {
                                    const adminBtn = document.createElement('button');
                                    adminBtn.id = 'admin-category-btn';
                                    adminBtn.className = 'btn-primary ml-2';
                                    adminBtn.innerHTML = '<i class="ph ph-folder-plus mr-1"></i> Kategori Ekle';
                                    adminBtn.onclick = toggleAdminCategoryForm;
                                    forumHeader.appendChild(adminBtn);
                                }
                            }
                        }
                        
                        // Initialize data listeners
                        setupRealtimeListeners();
                    } else {
                        // User is signed out
                        state.userId = crypto.randomUUID();
                        state.userRole = 'GUEST';
                        state.userName = 'Misafir';
                        document.getElementById('user-name').textContent = state.userName;
                    }
                });
            } catch (error) {
                console.error("Auth error:", error);
                // Fall back to anonymous ID if auth fails
                state.userId = crypto.randomUUID();
                state.userName = `Misafir-${state.userId.substring(0, 8)}`;
                document.getElementById('user-name').textContent = state.userName;
            }
        }
        
        // Setup real-time listeners
        function setupRealtimeListeners() {
            // Forum threads listener
            const threadsPath = getCollectionPath('forum_threads');
            const threadsQuery = query(
                collection(db, threadsPath),
                orderBy('timestamp', 'desc')
            );
            
            onSnapshot(threadsQuery, (snapshot) => {
                state.forumThreads = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Update UI based on current view
                if (state.currentView === 'forum') {
                    renderForumThreads();
                } else if (state.currentView === 'home') {
                    renderPopularThreads();
                }
            });
            
            // Forum categories listener
            const categoriesPath = getCollectionPath('forum_categories');
            onSnapshot(collection(db, categoriesPath), (snapshot) => {
                const firebaseCategories = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Merge with default categories, prioritizing Firebase data
                const mergedCategories = [...DEFAULT_FORUM_CATEGORIES];
                
                firebaseCategories.forEach(fbCat => {
                    const existingIndex = mergedCategories.findIndex(c => c.id === fbCat.id);
                    if (existingIndex >= 0) {
                        mergedCategories[existingIndex] = fbCat;
                    } else {
                        mergedCategories.push(fbCat);
                    }
                });
                
                state.forumCategories = mergedCategories;
                
                // Update UI if on forum view
                if (state.currentView === 'forum') {
                    renderForumCategories();
                    populateCategorySelects();
                }
            });
            
            // School news listener
            const newsPath = getCollectionPath('school_news');
            const newsQuery = query(
                collection(db, newsPath),
                orderBy('timestamp', 'desc')
            );
            
            onSnapshot(newsQuery, (snapshot) => {
                state.schoolNews = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Update UI based on current view
                if (state.currentView === 'news') {
                    renderSchoolNews();
                } else if (state.currentView === 'home') {
                    renderRecentNews();
                }
            });
        }
        
        // Forum thread replies listener
        let unsubscribeForumReplies = null;
        
        function startForumRepliesListener(threadId) {
            // Clean up previous listener if exists
            if (unsubscribeForumReplies) {
                unsubscribeForumReplies();
                unsubscribeForumReplies = null;
            }
            
            const repliesPath = `${getCollectionPath('forum_threads')}/${threadId}/replies`;
            const repliesQuery = query(
                collection(db, repliesPath),
                orderBy('timestamp', 'asc')
            );
            
            unsubscribeForumReplies = onSnapshot(repliesQuery, (snapshot) => {
                state.currentThreadReplies = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Update UI
                renderThreadReplies();
                
                // Update reply count on the thread
                const threadRef = doc(db, getCollectionPath('forum_threads'), threadId);
                updateDoc(threadRef, {
                    replyCount: state.currentThreadReplies.length
                });
            });
        }
        
        // Navigation
        function setView(viewName, params = {}) {
            // Clean up listeners from previous view
            if (unsubscribeForumReplies && state.currentView === 'thread-detail') {
                unsubscribeForumReplies();
                unsubscribeForumReplies = null;
            }
            
            // Update state
            state.currentView = viewName;
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the corresponding nav item
            if (['home', 'forum', 'news'].includes(viewName)) {
                const navItem = document.querySelector(`.nav-item[onclick="setView('${viewName}')"]`);
                if (navItem) navItem.classList.add('active');
            }
            
            // Handle special views
            if (viewName === 'thread-detail') {
                state.currentThread = params.thread;
                startForumRepliesListener(params.thread.id);
            }
            
            // Render the view
            renderCurrentView();
        }
        
        // Render current view
        function renderCurrentView() {
            const container = document.getElementById('view-container');
            container.innerHTML = '';
            
            // Show loading indicator
            const loadingView = document.getElementById('loading-view').content.cloneNode(true);
            container.appendChild(loadingView);
            
            // Render the appropriate view after a short delay
            setTimeout(() => {
                container.innerHTML = '';
                
                switch (state.currentView) {
                    case 'home':
                        renderHomeView();
                        break;
                    case 'forum':
                        renderForumView();
                        break;
                    case 'thread-detail':
                        renderThreadDetailView();
                        break;
                    case 'news':
                        renderNewsView();
                        break;
                    default:
                        renderHomeView();
                }
            }, 300);
        }
        
        // Home View
        function renderHomeView() {
            const container = document.getElementById('view-container');
            const template = document.getElementById('home-view').content.cloneNode(true);
            container.appendChild(template);
            
            // Render popular threads and recent news
            renderPopularThreads();
            renderRecentNews();
        }
        
        function renderPopularThreads() {
            const container = document.getElementById('popular-threads');
            if (!container) return;
            
            if (state.forumThreads.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Henüz konu bulunmuyor.</p>';
                return;
            }
            
            // Sort by upvotes and get top 5
            const popularThreads = [...state.forumThreads]
                .sort((a, b) => (b.upvotes || 0) - (a.upvotes || 0))
                .slice(0, 5);
            
            container.innerHTML = '';
            
            popularThreads.forEach(thread => {
                const threadEl = document.createElement('div');
                threadEl.className = 'flex items-center justify-between p-2 hover:bg-gray-50 rounded';
                threadEl.innerHTML = `
                    <div class="flex-1">
                        <a href="#" class="font-medium text-navy hover:text-turquoise">${thread.title}</a>
                        <div class="text-xs text-gray-500 mt-1">
                            ${thread.authorName} · ${formatDate(thread.timestamp)}
                        </div>
                    </div>
                    <div class="flex items-center gap-1 text-sm">
                        <i class="ph ph-arrow-fat-up"></i>
                        <span>${thread.upvotes || 0}</span>
                    </div>
                `;
                
                threadEl.querySelector('a').addEventListener('click', (e) => {
                    e.preventDefault();
                    setView('thread-detail', { thread });
                });
                
                container.appendChild(threadEl);
            });
        }
        
        function renderRecentNews() {
            const container = document.getElementById('recent-news');
            if (!container) return;
            
            if (state.schoolNews.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Henüz haber bulunmuyor.</p>';
                return;
            }
            
            // Get most recent 5 news
            const recentNews = state.schoolNews.slice(0, 5);
            
            container.innerHTML = '';
            
            recentNews.forEach(news => {
                const newsEl = document.createElement('div');
                newsEl.className = `p-2 hover:bg-gray-50 rounded ${news.isPinned ? 'border-l-2 border-gold' : ''}`;
                newsEl.innerHTML = `
                    <h4 class="font-medium text-navy">${news.title}</h4>
                    <div class="text-xs text-gray-500 mt-1">
                        ${news.authorName} · ${formatDate(news.timestamp)}
                    </div>
                `;
                
                container.appendChild(newsEl);
            });
        }
        
        // Forum View
        function renderForumView() {
            const container = document.getElementById('view-container');
            const template = document.getElementById('forum-view').content.cloneNode(true);
            container.appendChild(template);
            
            // Setup event listeners
            document.getElementById('new-thread-btn').addEventListener('click', toggleNewThreadForm);
            document.getElementById('thread-form').addEventListener('submit', handleNewThreadSubmit);
            document.getElementById('category-select').addEventListener('change', filterThreadsByCategory);
            
            // Show admin category button if admin
            if (state.userRole === 'ADMIN') {
                const forumHeader = document.querySelector('.flex.justify-between');
                const adminBtn = document.createElement('button');
                adminBtn.id = 'admin-category-btn';
                adminBtn.className = 'btn-primary ml-2';
                adminBtn.innerHTML = '<i class="ph ph-folder-plus mr-1"></i> Kategori Ekle';
                adminBtn.onclick = toggleAdminCategoryForm;
                forumHeader.appendChild(adminBtn);
                
                // Add event listener for category form
                document.getElementById('category-form').addEventListener('submit', handleNewCategorySubmit);
            }
            
            // Render forum categories and threads
            renderForumCategories();
            renderForumThreads();
            populateCategorySelects();
        }
        
        function renderForumCategories() {
            const container = document.getElementById('forum-categories');
            if (!container) return;
            
            container.innerHTML = '';
            
            state.forumCategories.forEach(category => {
                const categoryEl = document.createElement('div');
                categoryEl.className = 'card p-4 hover:shadow-md transition-all cursor-pointer';
                categoryEl.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-turquoise bg-opacity-10 flex items-center justify-center text-turquoise">
                            <i class="ph ph-${category.icon || 'folder'}"></i>
                        </div>
                        <div>
                            <h3 class="font-medium">${category.name}</h3>
                            <p class="text-sm text-gray-500">${category.description}</p>
                        </div>
                    </div>
                `;
                
                categoryEl.addEventListener('click', () => {
                    document.getElementById('category-select').value = category.id;
                    filterThreadsByCategory();
                });
                
                container.appendChild(categoryEl);
            });
        }
        
        function renderForumThreads(categoryFilter = 'all') {
            const container = document.getElementById('forum-threads');
            if (!container) return;
            
            if (state.forumThreads.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Henüz konu bulunmuyor.</p>';
                return;
            }
            
            // Filter threads by category if needed
            let filteredThreads = state.forumThreads;
            if (categoryFilter !== 'all') {
                filteredThreads = state.forumThreads.filter(thread => thread.category === categoryFilter);
            }
            
            container.innerHTML = '';
            
            if (filteredThreads.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Bu kategoride henüz konu bulunmuyor.</p>';
                return;
            }
            
            filteredThreads.forEach(thread => {
                const threadEl = document.createElement('div');
                threadEl.className = `thread-card p-4 ${thread.solutionReplyId ? 'solved' : ''}`;
                
                // Find category name
                const category = state.forumCategories.find(c => c.id === thread.category) || { name: 'Genel', icon: 'folder' };
                
                threadEl.innerHTML = `
                    <div class="flex justify-between">
                        <h3 class="font-medium text-lg">${thread.title}</h3>
                        <div class="flex items-center gap-2">
                            ${thread.solutionReplyId ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Çözüldü</span>' : ''}
                            <div class="flex items-center gap-1 text-sm">
                                <i class="ph ph-arrow-fat-up"></i>
                                <span>${thread.upvotes || 0}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mt-2 text-sm text-gray-500">
                        <span>${thread.authorName}</span>
                        <span>·</span>
                        <span>${formatDate(thread.timestamp)}</span>
                        <span>·</span>
                        <div class="category-pill flex items-center gap-1">
                            <i class="ph ph-${category.icon}"></i>
                            <span>${category.name}</span>
                        </div>
                    </div>
                    <p class="mt-3 text-gray-700 line-clamp-2">${thread.content}</p>
                    <div class="flex items-center gap-2 mt-3 text-sm">
                        <div class="flex items-center gap-1">
                            <i class="ph ph-chat"></i>
                            <span>${thread.replyCount || 0} cevap</span>
                        </div>
                        <button class="upvote-btn ml-auto text-sm flex items-center gap-1 text-gray-500 hover:text-turquoise">
                            <i class="ph ph-arrow-fat-up"></i>
                            <span>Oy Ver</span>
                        </button>
                    </div>
                `;
                
                // Add event listeners
                threadEl.addEventListener('click', (e) => {
                    if (!e.target.closest('.upvote-btn')) {
                        setView('thread-detail', { thread });
                    }
                });
                
                const upvoteBtn = threadEl.querySelector('.upvote-btn');
                upvoteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    upvoteThread(thread.id);
                });
                
                container.appendChild(threadEl);
            });
        }
        
        function populateCategorySelects() {
            // Populate category select in forum view
            const categorySelect = document.getElementById('category-select');
            const threadCategorySelect = document.getElementById('thread-category');
            
            if (categorySelect) {
                // Save current value
                const currentValue = categorySelect.value;
                
                // Clear options except "All"
                while (categorySelect.options.length > 1) {
                    categorySelect.remove(1);
                }
                
                // Add categories
                state.forumCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
                
                // Restore value if possible
                if (currentValue && [...categorySelect.options].some(opt => opt.value === currentValue)) {
                    categorySelect.value = currentValue;
                }
            }
            
            if (threadCategorySelect) {
                // Clear all options
                threadCategorySelect.innerHTML = '';
                
                // Add categories
                state.forumCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    threadCategorySelect.appendChild(option);
                });
            }
        }
        
        function filterThreadsByCategory() {
            const categorySelect = document.getElementById('category-select');
            const selectedCategory = categorySelect.value;
            renderForumThreads(selectedCategory);
        }
        
        function toggleNewThreadForm() {
            const form = document.getElementById('new-thread-form');
            form.classList.toggle('hidden');
        }
        
        function toggleAdminCategoryForm() {
            const form = document.getElementById('admin-category-form');
            form.classList.toggle('hidden');
        }
        
        async function handleNewThreadSubmit(e) {
            e.preventDefault();
            
            const titleInput = document.getElementById('thread-title');
            const categoryInput = document.getElementById('thread-category');
            const contentInput = document.getElementById('thread-content');
            
            const newThread = {
                title: titleInput.value.trim(),
                category: categoryInput.value,
                content: contentInput.value.trim(),
                authorId: state.userId,
                authorName: state.userName,
                timestamp: serverTimestamp(),
                replyCount: 0,
                upvotes: 0,
                solutionReplyId: null
            };
            
            try {
                // Add to Firestore
                await addDoc(collection(db, getCollectionPath('forum_threads')), newThread);
                
                // Reset form and hide
                titleInput.value = '';
                contentInput.value = '';
                toggleNewThreadForm();
            } catch (error) {
                console.error("Error adding thread:", error);
                alert("Konu eklenirken bir hata oluştu. Lütfen tekrar deneyin.");
            }
        }
        
        async function handleNewCategorySubmit(e) {
            e.preventDefault();
            
            // Check if user is admin
            if (state.userRole !== 'ADMIN') {
                alert("Bu işlem için yönetici yetkisi gereklidir.");
                return;
            }
            
            const idInput = document.getElementById('category-id');
            const nameInput = document.getElementById('category-name');
            const descriptionInput = document.getElementById('category-description');
            const iconInput = document.getElementById('category-icon');
            
            const categoryId = idInput.value.trim().toLowerCase();
            
            // Validate ID format (lowercase, hyphens only)
            if (!/^[a-z0-9-]+$/.test(categoryId)) {
                alert("Kategori ID'si sadece küçük harf, rakam ve tire içerebilir.");
                return;
            }
            
            const newCategory = {
                id: categoryId,
                name: nameInput.value.trim(),
                description: descriptionInput.value.trim(),
                icon: iconInput.value.trim() || 'folder'
            };
            
            try {
                // Add to Firestore with custom ID
                await setDoc(doc(db, getCollectionPath('forum_categories'), categoryId), newCategory);
                
                // Reset form and hide
                idInput.value = '';
                nameInput.value = '';
                descriptionInput.value = '';
                iconInput.value = 'folder';
                toggleAdminCategoryForm();
            } catch (error) {
                console.error("Error adding category:", error);
                alert("Kategori eklenirken bir hata oluştu. Lütfen tekrar deneyin.");
            }
        }
        
        async function upvoteThread(threadId) {
            try {
                const threadRef = doc(db, getCollectionPath('forum_threads'), threadId);
                await updateDoc(threadRef, {
                    upvotes: increment(1)
                });
            } catch (error) {
                console.error("Error upvoting thread:", error);
            }
        }
        
        // Thread Detail View
        function renderThreadDetailView() {
            const container = document.getElementById('view-container');
            const template = document.getElementById('thread-detail-view').content.cloneNode(true);
            container.appendChild(template);
            
            // Setup event listeners
            document.getElementById('reply-form').addEventListener('submit', handleNewReplySubmit);
            
            // Render thread details and replies
            renderThreadDetail();
            renderThreadReplies();
        }
        
        function renderThreadDetail() {
            const container = document.getElementById('thread-detail');
            if (!container || !state.currentThread) return;
            
            // Find category
            const category = state.forumCategories.find(c => c.id === state.currentThread.category) || { name: 'Genel', icon: 'folder' };
            
            container.innerHTML = `
                <div class="flex justify-between items-start">
                    <h2 class="text-2xl font-bold">${state.currentThread.title}</h2>
                    <div class="flex items-center gap-2">
                        ${state.currentThread.solutionReplyId ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Çözüldü</span>' : ''}
                        <div class="flex items-center gap-1 text-sm">
                            <i class="ph ph-arrow-fat-up"></i>
                            <span>${state.currentThread.upvotes || 0}</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2 mt-2 text-sm text-gray-500">
                    <span>${state.currentThread.authorName}</span>
                    <span>·</span>
                    <span>${formatDate(state.currentThread.timestamp)}</span>
                    <span>·</span>
                    <div class="category-pill flex items-center gap-1">
                        <i class="ph ph-${category.icon}"></i>
                        <span>${category.name}</span>
                    </div>
                </div>
                <div class="mt-4 text-gray-700 whitespace-pre-line">${state.currentThread.content}</div>
                <div class="mt-4 pt-4 border-t flex justify-end">
                    <button id="thread-upvote-btn" class="text-sm flex items-center gap-1 text-gray-500 hover:text-turquoise">
                        <i class="ph ph-arrow-fat-up"></i>
                        <span>Oy Ver</span>
                    </button>
                </div>
            `;
            
            // Add event listener for upvote
            document.getElementById('thread-upvote-btn').addEventListener('click', () => {
                upvoteThread(state.currentThread.id);
            });
        }
        
        function renderThreadReplies() {
            const container = document.getElementById('thread-replies');
            const replyCountEl = document.getElementById('reply-count');
            
            if (!container || !state.currentThread) return;
            
            // Update reply count
            if (replyCountEl) {
                replyCountEl.textContent = `${state.currentThreadReplies.length} cevap`;
            }
            
            if (state.currentThreadReplies.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Henüz cevap bulunmuyor.</p>';
                return;
            }
            
            container.innerHTML = '';
            
            state.currentThreadReplies.forEach(reply => {
                const isSolution = state.currentThread.solutionReplyId === reply.id;
                const canMarkAsSolution = state.currentThread.authorId === state.userId || state.userRole === 'ADMIN';
                
                const replyEl = document.createElement('div');
                replyEl.className = `card p-4 ${isSolution ? 'border-l-4 border-green-500' : ''}`;
                replyEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-2">
                            <span class="font-medium">${reply.authorName}</span>
                            <span class="text-xs text-gray-500">${formatDate(reply.timestamp)}</span>
                            ${isSolution ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Çözüm</span>' : ''}
                        </div>
                        ${canMarkAsSolution && !isSolution ? `
                            <button class="solution-btn text-xs text-gray-500 hover:text-green-600 flex items-center gap-1">
                                <i class="ph ph-check-circle"></i>
                                <span>Çözüm Olarak İşaretle</span>
                            </button>
                        ` : ''}
                    </div>
                    <div class="mt-3 text-gray-700 whitespace-pre-line">${reply.content}</div>
                `;
                
                // Add event listener for marking as solution
                if (canMarkAsSolution && !isSolution) {
                    const solutionBtn = replyEl.querySelector('.solution-btn');
                    if (solutionBtn) {
                        solutionBtn.addEventListener('click', () => {
                            markAsSolution(reply.id);
                        });
                    }
                }
                
                container.appendChild(replyEl);
            });
        }
        
        async function handleNewReplySubmit(e) {
            e.preventDefault();
            
            if (!state.currentThread) return;
            
            const contentInput = document.getElementById('reply-content');
            
            const newReply = {
                content: contentInput.value.trim(),
                authorId: state.userId,
                authorName: state.userName,
                timestamp: serverTimestamp()
            };
            
            try {
                // Add to Firestore as a subcollection
                const repliesPath = `${getCollectionPath('forum_threads')}/${state.currentThread.id}/replies`;
                await addDoc(collection(db, repliesPath), newReply);
                
                // Reset form
                contentInput.value = '';
            } catch (error) {
                console.error("Error adding reply:", error);
                alert("Cevap eklenirken bir hata oluştu. Lütfen tekrar deneyin.");
            }
        }
        
        async function markAsSolution(replyId) {
            if (!state.currentThread) return;
            
            // Check if user is thread author or admin
            if (state.currentThread.authorId !== state.userId && state.userRole !== 'ADMIN') {
                alert("Sadece konu sahibi veya yöneticiler çözüm işaretleyebilir.");
                return;
            }
            
            try {
                const threadRef = doc(db, getCollectionPath('forum_threads'), state.currentThread.id);
                await updateDoc(threadRef, {
                    solutionReplyId: replyId
                });
                
                // Update local state
                state.currentThread.solutionReplyId = replyId;
                
                // Re-render thread detail and replies
                renderThreadDetail();
                renderThreadReplies();
            } catch (error) {
                console.error("Error marking solution:", error);
                alert("Çözüm işaretlenirken bir hata oluştu. Lütfen tekrar deneyin.");
            }
        }
        
        // News View
        function renderNewsView() {
            const container = document.getElementById('view-container');
            const template = document.getElementById('news-view').content.cloneNode(true);
            container.appendChild(template);
            
            // Show admin controls if admin
            if (state.userRole === 'ADMIN') {
                const adminControls = document.getElementById('admin-news-controls');
                if (adminControls) adminControls.classList.remove('hidden');
                
                // Setup event listeners
                document.getElementById('new-news-btn').addEventListener('click', toggleNewNewsForm);
                document.getElementById('news-form').addEventListener('submit', handleNewNewsSubmit);
            }
            
            // Render news
            renderSchoolNews();
        }
        
        function renderSchoolNews() {
            const pinnedContainer = document.getElementById('pinned-news');
            const newsContainer = document.getElementById('news-list');
            
            if (!pinnedContainer || !newsContainer) return;
            
            // Clear containers
            pinnedContainer.innerHTML = '';
            newsContainer.innerHTML = '';
            
            if (state.schoolNews.length === 0) {
                newsContainer.innerHTML = '<p class="text-gray-500">Henüz haber bulunmuyor.</p>';
                return;
            }
            
            // Separate pinned and regular news
            const pinnedNews = state.schoolNews.filter(news => news.isPinned);
            const regularNews = state.schoolNews.filter(news => !news.isPinned);
            
            // Render pinned news
            if (pinnedNews.length > 0) {
                pinnedNews.forEach(news => {
                    const newsEl = document.createElement('div');
                    newsEl.className = 'card p-4 pinned-news';
                    newsEl.innerHTML = `
                        <div class="flex items-center gap-2 mb-2">
                            <i class="ph ph-push-pin text-gold"></i>
                            <h3 class="font-bold text-lg">${news.title}</h3>
                        </div>
                        <div class="text-gray-700 whitespace-pre-line">${news.content}</div>
                        <div class="mt-3 text-sm text-gray-500">
                            ${news.authorName} · ${formatDate(news.timestamp)}
                        </div>
                    `;
                    pinnedContainer.appendChild(newsEl);
                });
            }
            
            // Render regular news
            regularNews.forEach(news => {
                const newsEl = document.createElement('div');
                newsEl.className = 'card p-4';
                newsEl.innerHTML = `
                    <h3 class="font-bold text-lg mb-2">${news.title}</h3>
                    <div class="text-gray-700 whitespace-pre-line">${news.content}</div>
                    <div class="mt-3 text-sm text-gray-500">
                        ${news.authorName} · ${formatDate(news.timestamp)}
                    </div>
                `;
                newsContainer.appendChild(newsEl);
            });
        }
        
        function toggleNewNewsForm() {
            const form = document.getElementById('new-news-form');
            form.classList.toggle('hidden');
        }
        
        async function handleNewNewsSubmit(e) {
            e.preventDefault();
            
            // Check if user is admin
            if (state.userRole !== 'ADMIN') {
                alert("Bu işlem için yönetici yetkisi gereklidir.");
                return;
            }
            
            const titleInput = document.getElementById('news-title');
            const contentInput = document.getElementById('news-content');
            const isPinnedInput = document.getElementById('news-pinned');
            
            const newNews = {
                title: titleInput.value.trim(),
                content: contentInput.value.trim(),
                isPinned: isPinnedInput.checked,
                authorName: state.userName,
                timestamp: serverTimestamp()
            };
            
            try {
                // Add to Firestore
                await addDoc(collection(db, getCollectionPath('school_news')), newNews);
                
                // Reset form and hide
                titleInput.value = '';
                contentInput.value = '';
                isPinnedInput.checked = false;
                toggleNewNewsForm();
            } catch (error) {
                console.error("Error adding news:", error);
                alert("Haber eklenirken bir hata oluştu. Lütfen tekrar deneyin.");
            }
        }
        
        // Utility Functions
        function formatDate(timestamp) {
            if (!timestamp) return 'Bilinmeyen Tarih';
            
            // Convert Firebase timestamp to JS Date
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            
            // Format date
            return new Intl.DateTimeFormat('tr-TR', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize authentication
            initAuth();
            
            // Set initial view
            setView('home');
        });
        
        // Expose functions to global scope for HTML onclick handlers
        window.setView = setView;
        window.toggleNewThreadForm = toggleNewThreadForm;
        window.toggleAdminCategoryForm = toggleAdminCategoryForm;
        window.toggleNewNewsForm = toggleNewNewsForm;
    </script>
</body>
</html>
